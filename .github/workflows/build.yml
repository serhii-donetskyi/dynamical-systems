name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]

permissions:
  contents: write  # Required for uploading release assets

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.13']

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for setuptools_scm

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc build-essential

    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # XCode command line tools should be available
        xcode-select --install || true

    - name: Install system dependencies (Windows)
      if: matrix.os == 'windows-latest'
      uses: microsoft/setup-msbuild@v2

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build pytest setuptools wheel

    - name: Build package
      run: |
        python -m build --verbose

    - name: Install package
      run: |
        python -c "import os; [print(os.path.relpath(os.path.join(root, f), '.')) for root, dirs, files in os.walk('.') for f in files if f.endswith('.whl')]"
        python -c "import os, subprocess, glob; [subprocess.run(['python', '-m', 'pip', 'install', whl]) for whl in glob.glob(os.path.join('dist', '*.whl'))]"

    - name: Verify installation
      run: |
        python -c "import dynamical_systems; print('Package imported successfully')"
        python -c "from dynamical_systems import _dynamical_systems; print('C extension imported successfully')"
        python -c "from dynamical_systems import components; print('Components:', components)"

    - name: Run tests
      run: |
        pytest -v

  build-wheels:
    needs: test
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'release'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Build wheels
      uses: pypa/cibuildwheel@v2.19.2
      env:
        CIBW_SKIP: "pp* *-musllinux*"  # Skip PyPy and musl builds
        CIBW_ARCHS_LINUX: "x86_64 aarch64"
        CIBW_ARCHS_MACOS: "x86_64 arm64"
        CIBW_ARCHS_WINDOWS: "AMD64"
        CIBW_PRERELEASE_PYTHONS: true  # Enable Python 3.13 support
        CIBW_FREE_THREADED_SUPPORT: true  # Enable free-threaded Python support

    - name: Upload wheels
      uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.os }}
        path: wheelhouse/*.whl

  build-executables:
    needs: test
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'release'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.13']

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies and build executable
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -e .
      shell: bash

    - name: Build executable
      run: |
        pyinstaller dynamical-systems.spec --clean
      shell: bash

    - name: Set executable name
      shell: bash
      run: |
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          echo "EXECUTABLE_NAME=dynamical-systems.exe" >> $GITHUB_ENV
          echo "ARCHIVE_NAME=dynamical-systems-windows-x64.zip" >> $GITHUB_ENV
        elif [ "${{ matrix.os }}" == "macos-latest" ]; then
          echo "EXECUTABLE_NAME=dynamical-systems" >> $GITHUB_ENV
          echo "ARCHIVE_NAME=dynamical-systems-macos-arm64.zip" >> $GITHUB_ENV
        else
          echo "EXECUTABLE_NAME=dynamical-systems" >> $GITHUB_ENV
          echo "ARCHIVE_NAME=dynamical-systems-linux-x64.zip" >> $GITHUB_ENV
        fi

    - name: Create zip archive (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        Compress-Archive -Path (Join-Path "dist" "${{ env.EXECUTABLE_NAME }}") -DestinationPath "${{ env.ARCHIVE_NAME }}"

    - name: Create zip archive (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        cd dist
        zip -r ../${{ env.ARCHIVE_NAME }} ${{ env.EXECUTABLE_NAME }}
      shell: bash

    - name: Upload executable artifact
      uses: actions/upload-artifact@v4
      with:
        name: executable-${{ matrix.os }}
        path: ${{ env.ARCHIVE_NAME }}

    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.ARCHIVE_NAME }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # publish:
  #   needs: [build-wheels, build-executables]
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'release'
  #   steps:
  #   - name: Download all wheels
  #     uses: actions/download-artifact@v4
  #     with:
  #       path: dist

  #   - name: Publish to PyPI
  #     uses: pypa/gh-action-pypi-publish@v1.8.10
  #     with:
  #       password: ${{ secrets.PYPI_API_TOKEN }}
  #       packages_dir: dist/**/
